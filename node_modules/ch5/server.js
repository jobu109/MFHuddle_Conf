/**
 * Created by karaketsu on 14-8-27.
 */

var express = require('express');
var app = express();
var server = require('http').createServer(app);
var io = require('socket.io')(server);

server.listen(3000);

app.use(express.static('public'));

io.on('connection', function(socket) {
    socket.on('create or join', function (channel) {
        var room = io.nsps['/'].adapter.rooms[channel];
        var numClients = 0;
        if (room) numClients = Object.keys(room).length;
        console.log('numClients = ' + numClients);

        if (numClients == 0) {
            socket.join(channel);
            socket.emit('created', channel);
        } else if (numClients == 1) {
            io.sockets.in(channel).emit('join', channel);
            socket.join(channel);
            socket.emit('joined', channel);
        } else {
            socket.emit('full', channel);
        }
    });

    socket.on('message', function(msg) {
        console.log('S --> got message: ' + msg);
        socket.broadcast.to(msg.channel).emit('message', msg.message);
    });
});